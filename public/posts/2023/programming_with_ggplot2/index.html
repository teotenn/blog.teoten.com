<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
 <head>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather">
  <link href="/styles/1207b02cb143/styles.css" rel="stylesheet">
  <title>Programming with ggplot2 | Teoten's blog</title>
  <meta name="description" content="Part III of making maps of any region in the world with R using ggplot2 and maps packages: how to make functions for graphics in R">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Teoten">
  <meta name="fediverse:creator" content="@teoten@social.linux.pizza">
 </head>
 <body>
  <!-- Top nav bar -->
  <div>
   <!-- Toggle Button -->
   <button id="theme-toggle-btn" onclick="toggleTheme()"><i class="fas fa-sun"></i></button>
   <div id="wrapper">
    <nav id="navbar" class="navbar">
     <div class="navbar-container">
      <input type="checkbox" name="" id="">
      <div class="hamburger-lines">
       <span class="line line1"></span> <span class="line line2"></span> <span class="line line3"></span>
      </div>
      <ul class="menu-items">
       <li><a href="https://blog.teoten.com/">Home</a></li>
       <li><a href="https://blog.teoten.com/list/">Posts</a></li>
       <li><a href="https://blog.teoten.com/categories/">Categories</a></li>
       <li><a href="https://blog.teoten.com/tags/">Tags</a></li>
       <li><a href="https://blog.teoten.com/about/">About</a></li>
      </ul>
     </div>
    </nav>
   </div>
  </div>
  <div id="shadow-block">
   <div id="container">
    <div id="wide-content">
     <!-- Main content -->
     <div class="article-top">
      <img src="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png" class="article-top-image" alt="Programming with ggplot2">
      <div class="article-title-container">
       <h1 class="article-title">Programming with ggplot2</h1>
      </div>
      <div class="article-meta">
       <span> <i class="fa fa-calendar"> 2023-04-19</i> </span>
      </div>
     </div>
     <article id="post-/posts/2023/programming_with_ggplot2/" data-post-id="/posts/2023/programming_with_ggplot2/">
      <div>
       <p>This post is part of the series <a href="https://blog.teoten.com/series/maps-app/" title="maps-app">maps-app</a>.</p>
       <p>You can also find the current state of the project under <a href="https://github.com/teotenn">my GitHub</a> repo <a href="https://github.com/teotenn/mapic">mapic</a>.</p>
       <h1 class="article-header">Scope of this post</h1>
       <p>We are creating maps of data showing changes over a span of time for different countries and pointing at all kinds of cities. That basically means that we need to <strong>map any region of the world with R</strong>. Today there are all kinds of packages and techniques to do that. I will share the strategy I used with <a href="https://cran.r-project.org/web/packages/ggplot2/index.html">ggplot2</a> and <a href="https://cran.r-project.org/web/packages/maps/index.html">maps</a> packages, using support of <a href="https://www.openstreetmap.org/">Open Street Map</a> to obtain the coordinates of cities and finally making it interactive with <a href="https://shiny.rstudio.com/">shiny</a>.</p>
       <p>This series of posts share my path towards the creation of the Shiny app. It is a live project and I decided to share my path and experiences along the creation process. The posts are not only about the Shiny app, but the package I created behind it, including topics of functions crafting, creation of the maps, classes of objects, etc., as well as any interesting issue that appear on the way. It is my way to contribute to the R community and at the same time keeping the project documented for myself.</p>
       <p>This post is about <strong>Creating functions for ggplot</strong>.</p>
       <p>I hope you all enjoy it. Feel free to leave any kind of comment and/or question at the end.</p>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png"><img alt="R Maps" src="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png"></a>
       </div>
       <p></p>
       <h1 class="article-header">Background and preliminaries</h1>
       <p>In the <a href="https://blog.teoten.com/posts/2022/basic_country_map_with_r/">first post</a> we created a function to create the basic map. Since then I have modified the function slightly, but the concept is the same. You can see below the most up to date version and compare it with the <a href="https://blog.teoten.com/posts/2022/basic_country_map_with_r/#function-to-create-the-basic-map-in-r">previous version</a> if you wish.</p>
       <pre><code class="highlight"><span></span><span class="n">my_country_prev</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span>
                            <span class="n">map_colors</span><span class="p">,</span>
                            <span class="n">x_limits</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                            <span class="n">y_limits</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                            <span class="n">show_coords</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

  <span class="c1">## Verifying the arguments passed to the function</span>
  <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">country</span><span class="p">)</span> <span class="o">!=</span> <span class="m">1</span><span class="p">)</span> <span class="nf">stop</span><span class="p">(</span><span class="s">"Function supports only one country per map"</span><span class="p">)</span>
  <span class="nf">stopifnot</span><span class="p">(</span><span class="nf">is.logical</span><span class="p">(</span><span class="n">show_coords</span><span class="p">))</span>
  <span class="nf">stopifnot</span><span class="p">(</span><span class="s">"Name of the country should be character"</span> <span class="o">=</span> <span class="nf">is.character</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>

  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">country</span> <span class="o">%in%</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">'world'</span><span class="p">)</span><span class="o">$</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">stop</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">"Country name not recognized"</span><span class="p">,</span>
               <span class="s">"To see a list of recognized countries run"</span><span class="p">,</span>
               <span class="s">"&lt;unique(maps::map_data('world')$region)&gt;"</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">"\n"</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="c1">## If coords limits missing, print worldwide map with coordinates system to allow</span>
  <span class="c1">## User observe coords for reference</span>
  <span class="nf">if </span><span class="p">(</span><span class="nf">missing</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span> <span class="o">||</span> <span class="nf">missing</span><span class="p">(</span><span class="n">y_limits</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">warning</span><span class="p">(</span><span class="s">"X and/or Y limits not provided.\nPrinting worldwide map."</span><span class="p">)</span>
    <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">))</span>
  <span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">show_coords</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">))</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span> <span class="o">!=</span> <span class="m">2</span> <span class="o">||</span> <span class="nf">length</span><span class="p">(</span><span class="n">y_limits</span><span class="p">)</span> <span class="o">!=</span> <span class="m">2</span> <span class="o">||</span>
         <span class="o">!</span><span class="nf">all</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">"^-?[0-9.]+$"</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="n">x_limits</span><span class="p">,</span> <span class="n">y_limits</span><span class="p">))))</span> <span class="p">{</span>
      <span class="nf">stop</span><span class="p">(</span><span class="s">"Limits for X and Y coords should be provided as vectors with two numeric values"</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>

      <span class="c1">## All the received inputs are correct.</span>
      <span class="c1">## Let's define our custom theme for the final map</span>
      <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
        <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">),</span>
              <span class="n">legend.position</span> <span class="o">=</span> <span class="s">"none"</span><span class="p">,</span>
              <span class="n">panel.grid.major</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.line</span> <span class="o">=</span> <span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="s">"black"</span><span class="p">),</span>
              <span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.text.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.ticks.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.text.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.ticks.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">## make a df with only the country to overlap</span>
  <span class="n">map_data_country</span> <span class="o">&lt;-</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">'world'</span><span class="p">)</span><span class="nf">[map_data</span><span class="p">(</span><span class="s">'world'</span><span class="p">)</span><span class="o">$</span><span class="n">region</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="n">]</span>
  <span class="c1">## The map (maps + ggplot2 )</span>
  <span class="n">mapic</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>
    <span class="c1">## First layer: worldwide map</span>
    <span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">"world"</span><span class="p">),</span>
                 <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">),</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">border_countries</span><span class="p">,</span> <span class="c1"># border countries</span>
                 <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">empty_countries</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># empty countries</span>
    <span class="c1">## Second layer: Country map</span>
    <span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">map_data_country</span><span class="p">,</span>
                 <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">),</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">border_countries</span><span class="p">,</span> <span class="c1"># border target country</span>
                 <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">target_country</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># target country</span>
    <span class="nf">coord_map</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">coord_fixed</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">x_limits</span><span class="p">,</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">y_limits</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">map_country_theme</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">mapic</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>One critical difference is the argument <code>map_colors</code> that is nor explained or well defined. This is a list object containing the values for the colors to be used for all the elements of the maps. There are different ways to define and use this. The idea is to make it an S3 object and explain it on its own, but it is a topic that I am still exploring and I haven't decided yet the details of it. For now, let's use it simply as a list containing our chosen colors for the map.</p>
       <pre><code class="highlight"><span></span><span class="n">map_colors</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">dots_orgs</span> <span class="o">=</span> <span class="s">"#493252"</span><span class="p">,</span>
                   <span class="n">target_country</span> <span class="o">=</span> <span class="s">"#8caeb4"</span><span class="p">,</span>
                   <span class="n">empty_countries</span> <span class="o">=</span> <span class="s">"#f3f3f3"</span><span class="p">,</span>
                   <span class="n">border_countries</span> <span class="o">=</span> <span class="s">"#9c9c9c"</span><span class="p">,</span>
                   <span class="n">oceans</span> <span class="o">=</span> <span class="s">"#4e91d2"</span><span class="p">,</span>
                   <span class="n">text_cities</span> <span class="o">=</span> <span class="s">"#a0a0a0"</span><span class="p">,</span>
                   <span class="n">text_legend</span> <span class="o">=</span> <span class="s">"#493252"</span><span class="p">,</span>
                   <span class="n">background_legend</span> <span class="o">=</span> <span class="s">"#ffffff"</span><span class="p">,</span>
                   <span class="n">text_copyright</span> <span class="o">=</span> <span class="s">"#f3f3f3"</span><span class="p">)</span>
</code></pre>
       <p>The function easily prints the map of any country, using the naming from the package <code>maps</code>. Now we want to add the data to it.</p>
       <p>Now we need to define some simple data frame simulating a collection of organizations in Mexico.</p>
       <pre><code class="highlight"><span></span><span class="n">mx_data</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span>
  <span class="n">ID</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">),</span>
  <span class="n">Name</span> <span class="o">=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="s">"org%d"</span><span class="p">,</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">)),</span>
  <span class="n">Registration_year</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2001</span><span class="o">:</span><span class="m">2010</span><span class="p">),</span>
  <span class="n">Country</span> <span class="o">=</span> <span class="s">"MX"</span><span class="p">,</span>
  <span class="n">Region</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
             <span class="s">"Baja California Norte"</span><span class="p">,</span>
             <span class="s">"Mexico"</span><span class="p">,</span>
             <span class="s">"Jalisco"</span><span class="p">,</span>
             <span class="s">"Queretaro"</span><span class="p">,</span>
             <span class="s">"Baja California Norte"</span><span class="p">,</span>
             <span class="s">"Mexico"</span><span class="p">,</span>
             <span class="s">"Morelos"</span><span class="p">,</span>
             <span class="s">"Mexico"</span><span class="p">,</span>
             <span class="s">"Estado de Mexico"</span><span class="p">),</span>
  <span class="n">City</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Ciudad de Mexico"</span><span class="p">,</span>
           <span class="s">"Tijuana"</span><span class="p">,</span>
           <span class="s">"Ciudad de Mexico"</span><span class="p">,</span>
           <span class="s">"Guadalajara"</span><span class="p">,</span>
           <span class="s">"Queretaro"</span><span class="p">,</span>
           <span class="s">"Tijuana"</span><span class="p">,</span>
           <span class="s">"Ciudad de Mexico"</span><span class="p">,</span>
           <span class="s">"Cuernavaca"</span><span class="p">,</span>
           <span class="s">"Ciudad de Mexico"</span><span class="p">,</span>
           <span class="s">"Texcoco"</span><span class="p">))</span>
</code></pre>
       <p>We can see it as a company that along 10 years managed to open one new franchise per year, and we want to map where each is located and where it has grown the most. For that, we need the coordinates of the cities where each franchise is located. We can easily obtain that using code from the previous posts: either directly from <a href="https://blog.teoten.com/posts/2022/getting_coordinates_for_maps_in_r_via_api/">part II</a> or the <a href="https://blog.teoten.com/posts/2023/webscrap_and_iteration_in_r/">improved version of the function</a>.</p>
       <pre><code class="highlight"><span></span><span class="nf">webscrap_to_db</span><span class="p">(</span><span class="n">db_name</span> <span class="o">=</span> <span class="s">"test-mex.sqlite"</span><span class="p">,</span>
               <span class="n">dat</span> <span class="o">=</span> <span class="n">mx_data</span><span class="p">,</span>
               <span class="n">city</span> <span class="o">=</span> <span class="s">"City"</span><span class="p">,</span>
               <span class="n">country</span> <span class="o">=</span> <span class="s">"Country"</span><span class="p">,</span>
               <span class="n">db_backup_after</span> <span class="o">=</span> <span class="m">5</span><span class="p">)</span>
</code></pre>
       <p>And also using previously defined functions, we can combine the data with the just obtained coordinates system.</p>
       <pre><code class="highlight"><span></span><span class="p">(</span><span class="n">datmx</span> <span class="o">&lt;-</span> <span class="nf">combine_csv_sql</span><span class="p">(</span><span class="n">db_file</span> <span class="o">=</span> <span class="s">"test-mex.sqlite"</span><span class="p">,</span>
                         <span class="n">csv_file</span> <span class="o">=</span> <span class="n">mx_data</span><span class="p">))</span>
</code></pre>
       <pre><code class="highlight"><span></span><span class="err">&gt;    ID  Name Registration_year             City Country Region State County</span>
<span class="err">&gt; 1   1  org1              2001 Ciudad de Mexico      MX                    </span>
<span class="err">&gt; 2   2  org2              2002          Tijuana      MX                    </span>
<span class="err">&gt; 3   3  org3              2003 Ciudad de Mexico      MX                    </span>
<span class="err">&gt; 4   4  org4              2004      Guadalajara      MX                    </span>
<span class="err">&gt; 5   5  org5              2005        Queretaro      MX                    </span>
<span class="err">&gt; 6   6  org6              2006          Tijuana      MX                    </span>
<span class="err">&gt; 7   7  org7              2007 Ciudad de Mexico      MX                    </span>
<span class="err">&gt; 8   8  org8              2008       Cuernavaca      MX                    </span>
<span class="err">&gt; 9   9  org9              2009 Ciudad de Mexico      MX                    </span>
<span class="err">&gt; 10 10 org10              2010          Texcoco      MX                    </span>
<span class="err">&gt;                                                            osm_name        lon</span>
<span class="err">&gt; 1                                          Ciudad de México, México  -99.13318</span>
<span class="err">&gt; 2     Tijuana, Municipio de Tijuana, Baja California, 22320, México -117.01953</span>
<span class="err">&gt; 3                                          Ciudad de México, México  -99.13318</span>
<span class="err">&gt; 4                                      Guadalajara, Jalisco, México -103.33840</span>
<span class="err">&gt; 5  Santiago de Querétaro, Municipio de Querétaro, Querétaro, México -100.39706</span>
<span class="err">&gt; 6     Tijuana, Municipio de Tijuana, Baja California, 22320, México -117.01953</span>
<span class="err">&gt; 7                                          Ciudad de México, México  -99.13318</span>
<span class="err">&gt; 8                                Cuernavaca, Morelos, 62000, México  -99.23423</span>
<span class="err">&gt; 9                                          Ciudad de México, México  -99.13318</span>
<span class="err">&gt; 10                                   Texcoco, Carbó, Sonora, México -111.05867</span>
<span class="err">&gt;         lat</span>
<span class="err">&gt; 1  19.43263</span>
<span class="err">&gt; 2  32.53174</span>
<span class="err">&gt; 3  19.43263</span>
<span class="err">&gt; 4  20.67204</span>
<span class="err">&gt; 5  20.59547</span>
<span class="err">&gt; 6  32.53174</span>
<span class="err">&gt; 7  19.43263</span>
<span class="err">&gt; 8  18.92183</span>
<span class="err">&gt; 9  19.43263</span>
<span class="err">&gt; 10 29.63900</span>
</code></pre>
       <p>Now <code>datmx</code> should have the coordinates, together with the rest of the data about our franchises. We should also have our SQLite file and, of course, our source data. It means that we are ready to add the data to the map.</p>
       <h1 class="article-header">Programming with ggplot2</h1>
       <p>If you ever wondered how to create functions with ggplot2, there are a few ways, but here is the basic point that we need to understand, if we want to have them working in the same style as ggplot works:</p>
       <p>Once you have the base plot with the function <code>ggplot()</code> you can add geoms and stats to it by simply using <code>+</code>, or you can create new functions by returning a <code>list</code> of geoms and stats.</p>
       <p>The first point is as simple as the following lines:</p>
       <pre><code class="highlight"><span></span><span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">),</span> <span class="n">y_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">"A map of Mexico"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/map1-1.png"><img alt="plot of chunk map1" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/map1-1.png"></a>
       </div>
       <p></p>
       <p>Or we could do the same by creating a function and returning the title inside a list.</p>
       <pre><code class="highlight"><span></span><span class="n">my_title</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">ggtitle</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
<span class="p">}</span>

<span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">),</span> <span class="n">y_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">my_title</span><span class="p">(</span><span class="s">"The same map of Mexico"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/map2-1.png"><img alt="plot of chunk map2" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/map2-1.png"></a>
       </div>
       <p></p>
       <p>With that in mind, we can do all the calculations we want and start adding the data in form of geoms and stats to the base map.</p>
       <h2 class="article-header">A map with growing dots per city</h2>
       <p>We started with something simple, adding the amount of organizations per city, as growing dots.</p>
       <pre><code class="highlight"><span></span><span class="n">make_dots</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">.df</span><span class="p">,</span>
                      <span class="n">year</span><span class="p">,</span>
                      <span class="n">map_colors</span><span class="p">,</span>
                      <span class="n">column_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="s">"lat"</span><span class="p">,</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="s">"lon"</span><span class="p">,</span>
                        <span class="n">cities</span> <span class="o">=</span> <span class="s">"city"</span><span class="p">,</span>
                        <span class="n">start_year</span> <span class="o">=</span> <span class="s">"year"</span><span class="p">,</span>
                        <span class="n">end_year</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">),</span>
                      <span class="n">dot_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>

  <span class="c1">## Some error handling</span>
  <span class="n">mandatory_cols</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"lat"</span><span class="p">,</span> <span class="s">"lon"</span><span class="p">,</span> <span class="s">"cities"</span><span class="p">,</span> <span class="s">"start_year"</span><span class="p">)</span>
  <span class="nf">if</span><span class="p">(</span><span class="o">!</span><span class="nf">all</span><span class="p">(</span><span class="n">mandatory_cols</span> <span class="o">%in%</span> <span class="nf">names</span><span class="p">(</span><span class="n">column_names</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nf">stop</span><span class="p">(</span><span class="s">"Column names missing!"</span><span class="p">)</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="s">"end_year"</span> <span class="o">%in%</span> <span class="nf">names</span><span class="p">(</span><span class="n">column_names</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">.df</span><span class="o">$</span><span class="n">final_year</span> <span class="o">&lt;-</span> <span class="kc">NA_real_</span>
      <span class="n">column_names[[</span><span class="s">"end_year"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="s">"final_year"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">## Dots base size</span>
  <span class="n">base_size</span> <span class="o">&lt;-</span> <span class="m">5</span>
  <span class="n">dot_sizes</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">),</span>
                 <span class="m">9</span> <span class="o">*</span> <span class="p">(</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">dot_size</span><span class="p">))</span>

  <span class="c1">## Data manipulation to be used in the map</span>
  <span class="n">filt</span> <span class="o">&lt;-</span> <span class="n">.df</span>  <span class="o">%&gt;%</span>
    <span class="nf">mutate</span><span class="p">(</span><span class="n">year_final</span> <span class="o">=</span> <span class="nf">replace_na</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">end_year</span><span class="p">),</span> <span class="n">year</span> <span class="o">+</span> <span class="m">1</span><span class="p">),</span>
           <span class="n">city_name</span> <span class="o">=</span> <span class="nf">str_to_sentence</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">cities</span><span class="p">)))</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span><span class="n">year_final</span> <span class="o">&gt;</span> <span class="n">year</span> <span class="o">&amp;</span> <span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">start_year</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">year</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">group_by</span><span class="p">(</span><span class="n">city_name</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">summarise</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nf">median</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">lon</span><span class="p">),</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="bp">T</span><span class="p">),</span>
              <span class="n">y</span> <span class="o">=</span> <span class="nf">median</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">lat</span><span class="p">),</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="bp">T</span><span class="p">),</span>
              <span class="n">n</span> <span class="o">=</span> <span class="nf">n</span><span class="p">())</span> <span class="o">%&gt;%</span>
    <span class="nf">mutate</span><span class="p">(</span><span class="n">dot_size</span> <span class="o">=</span> <span class="nf">case_when</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="m">1</span> <span class="o">~</span> <span class="n">dot_sizes[1]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">2</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">5</span> <span class="o">~</span> <span class="n">dot_sizes[2]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">6</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">10</span> <span class="o">~</span> <span class="n">dot_sizes[3]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">11</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">30</span> <span class="o">~</span> <span class="n">dot_sizes[4]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">31</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">50</span> <span class="o">~</span> <span class="n">dot_sizes[5]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">51</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">100</span> <span class="o">~</span> <span class="n">dot_sizes[6]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">101</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">200</span> <span class="o">~</span> <span class="n">dot_sizes[7]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">201</span> <span class="o">&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">300</span> <span class="o">~</span> <span class="n">dot_sizes[8]</span><span class="p">,</span> 
                                <span class="n">n</span> <span class="o">&gt;=</span> <span class="m">301</span> <span class="o">~</span> <span class="n">dot_sizes[9]</span><span class="p">,</span>
                                <span class="kc">TRUE</span> <span class="o">~</span> <span class="kc">NA</span><span class="p">))</span>

  <span class="c1">## -------------------------- MAIN MAP ----------------------------------</span>
  <span class="n">map_points</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span>
    <span class="nf">geom_point</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">filt</span><span class="p">,</span>
               <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">dot_size</span><span class="p">),</span>
               <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">dots_orgs</span><span class="p">,</span>
               <span class="n">alpha</span> <span class="o">=</span> <span class="m">7</span><span class="o">/</span><span class="m">10</span><span class="p">,</span>
               <span class="n">shape</span> <span class="o">=</span> <span class="m">19</span><span class="p">)</span> <span class="p">,</span>
    <span class="nf">scale_size_identity</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
                        <span class="n">breaks</span> <span class="o">=</span> <span class="n">dot_sizes</span><span class="p">,</span> 
                        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">'1'</span><span class="p">,</span> <span class="s">'2-5'</span><span class="p">,</span> <span class="s">'6-10'</span><span class="p">,</span> <span class="s">'11-30'</span><span class="p">,</span> <span class="s">'31-50'</span><span class="p">,</span>
                                   <span class="s">'51-100'</span><span class="p">,</span> <span class="s">'101-200'</span><span class="p">,</span> <span class="s">'201-300'</span><span class="p">,</span> <span class="s">'&gt;300'</span><span class="p">),</span>
                        <span class="n">guide</span> <span class="o">=</span> <span class="nf">guide_legend</span><span class="p">(</span><span class="n">label.position</span> <span class="o">=</span> <span class="s">'bottom'</span><span class="p">,</span>
                                             <span class="n">label.vjust</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
                                             <span class="n">nrow</span> <span class="o">=</span> <span class="m">1</span><span class="p">)),</span>
    <span class="nf">geom_point</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nf">filter</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">n</span> <span class="o">==</span> <span class="m">1</span><span class="p">),</span>
               <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
               <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">dots_orgs</span><span class="p">,</span>
               <span class="n">shape</span> <span class="o">=</span> <span class="m">19</span><span class="p">,</span>
               <span class="n">size</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span> <span class="p">,</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">'bottom'</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">map_points</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>As you can see, the function also requires our object <code>map_colors</code>, which we created before. Another way of passing values from a list is by defining these values directly within the function arguments, as we did here for <code>column_names</code>. We could pass the arguments directly when calling the function, or define them earlier to be used. Let's use the second approach.</p>
       <pre><code class="highlight"><span></span><span class="n">col_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="s">"lat"</span><span class="p">,</span>
                 <span class="n">lon</span> <span class="o">=</span> <span class="s">"lon"</span><span class="p">,</span>
                 <span class="n">cities</span> <span class="o">=</span> <span class="s">"City"</span><span class="p">,</span>
                 <span class="n">start_year</span> <span class="o">=</span> <span class="s">"Registration_year"</span><span class="p">)</span>
</code></pre>
       <p>If you look at the data frame that we created containing the data, this are simply the names of the columns as we specified them.</p>
       <p>Now, about the function itself, it starts, as expected, by calling the libraries and then doing a bit of error handling to ensure that the fields that are strictly required are actually present in the data frame. There I am also adding the options for the <code>end_year</code> which is used in case some franchise closed and we want to map it only for the period of time it was present.</p>
       <p>Then we define the <strong>"Dots base size"</strong>. Here we experimented with so many sizes, both for the dots and for the final map, and this are the ones that look the best. Still, I'm allowing this value to be changed as the parameter <code>dot_size</code> in the function definition, however I wouldn't recommend changing it. You can also play with the internal values and see it for yourself. Since the idea here is to create functions for the "standards" of the maps, allowing minimal changes, we are not so strict as per how big the dots should be, yet we have certain degree of control.</p>
       <p>Then we do a little bit of data manipulation before being able to use the data. This includes the standardization of the names of Cities (up to some degree), filtering the data that does not match with the selected year, using only the median value of the latitude and longitude data, and defining the sizes of the dots according to the amount of franchises. The last one is a tricky one that I haven't decided yet what amount of freedom should still be out there. Maybe there should be a separated function to define all that. Our maps were created to handle data containing from few hundreds of rows, to a couple of thousands, thus, the values presented here. But if you want to show just a few organizations (as is the case of this example), the map looks quite deserted; on the other hand, if you need to map values of thousands per city, the maps look overloaded. For the present post I'm keeping it as is, with a note for consideration. We also added one extra <code>geom_point</code> to overwrite the alpha value for the case of only 1, and make it solid. This also works well on the visuals.</p>
       <p>In any case, the function above shows how we can manipulate the data inside a function, and return only what we need to add it to an existent ggplot. We can now add the dots as we would normally do in ggplot style.</p>
       <pre><code class="highlight"><span></span><span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                 <span class="n">x_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">),</span>
                 <span class="n">y_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">),</span>
                 <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">make_dots</span><span class="p">(</span><span class="n">datmx</span><span class="p">,</span>
            <span class="n">year</span> <span class="o">=</span> <span class="m">2022</span><span class="p">,</span>
            <span class="n">map_colors</span><span class="p">,</span> <span class="n">column_names</span> <span class="o">=</span> <span class="n">col_names</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="n">n.breaks</span> <span class="o">=</span> <span class="m">20</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">"A map of Mexico"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-5-1.png"><img alt="plot of chunk unnamed-chunk-5" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-5-1.png"></a>
       </div>
       <p></p>
       <h2 class="article-header">Adding labels for the map</h2>
       <p>Moving forward, we want to add some labels to the maps to know what we are seeing. Here I created one function to show which year is being mapped, and a second one to show the totals. Although we can achieve that easily in different ways, I managed to make it complicated, keeping in mind that we want to map any region in the world.</p>
       <pre><code class="highlight"><span></span><span class="n">my_print_years</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_limits</span><span class="p">,</span> <span class="n">y_limits</span><span class="p">,</span> <span class="n">year_label</span> <span class="o">=</span> <span class="s">"Year"</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">## POSITION FOR THE LABELS</span>
  <span class="c1">## Starting points</span>
  <span class="n">x_units</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">x_limits[1]</span> <span class="o">-</span> <span class="n">x_limits[2]</span><span class="p">)</span><span class="o">/</span><span class="m">10</span>
  <span class="n">y_units</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">y_limits[1]</span> <span class="o">-</span> <span class="n">y_limits[2]</span><span class="p">)</span><span class="o">/</span><span class="m">10</span>
  <span class="n">start_x</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span>
  <span class="n">start_y</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">y_limits</span><span class="p">)</span>
  <span class="c1">## Frame</span>
  <span class="n">rectangle.start.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span>
  <span class="n">rectangle.wide</span> <span class="o">&lt;-</span> <span class="n">rectangle.start.x</span> <span class="o">+</span> <span class="n">x_units</span>
  <span class="n">rectangle.start.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span>
  <span class="n">rectangle.high</span> <span class="o">&lt;-</span> <span class="n">rectangle.start.y</span> <span class="o">+</span> <span class="n">y_units</span>
  <span class="c1">## Text</span>
  <span class="n">num.size</span> <span class="o">&lt;-</span> <span class="m">4</span>
  <span class="n">text.size</span> <span class="o">&lt;-</span> <span class="m">3</span>  
  <span class="n">num.position.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_units</span> <span class="o">*</span> <span class="m">0.5</span><span class="p">)</span>
  <span class="n">text.position.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_units</span> <span class="o">*</span> <span class="m">0.5</span><span class="p">)</span>
  <span class="n">num.position.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_units</span> <span class="o">*</span> <span class="m">0.25</span><span class="p">)</span>
  <span class="n">text.position.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_units</span> <span class="o">*</span> <span class="m">0.65</span><span class="p">)</span>

  <span class="c1">## Adding the ggplot geoms</span>
  <span class="n">pyears</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span>
    <span class="nf">geom_rect</span><span class="p">(</span>
      <span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">rectangle.start.x</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">rectangle.wide</span><span class="p">,</span>
          <span class="n">ymin</span> <span class="o">=</span> <span class="n">rectangle.start.y</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">rectangle.high</span><span class="p">),</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">text_legend</span><span class="p">,</span>
      <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">text_legend</span><span class="p">,</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="m">9</span><span class="o">/</span><span class="m">10</span><span class="p">),</span>
    <span class="nf">geom_text</span><span class="p">(</span>
      <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">num.position.x</span><span class="p">,</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">num.position.y</span><span class="p">,</span>
          <span class="n">label</span> <span class="o">=</span> <span class="n">year</span><span class="p">),</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">num.size</span><span class="p">,</span>
      <span class="n">fontface</span> <span class="o">=</span> <span class="s">'bold'</span><span class="p">,</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">background_legend</span><span class="p">),</span>
    <span class="nf">geom_text</span><span class="p">(</span>
      <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">text.position.x</span><span class="p">,</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">text.position.y</span><span class="p">,</span>
          <span class="n">label</span> <span class="o">=</span> <span class="n">year_label</span><span class="p">),</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">text.size</span><span class="p">,</span>
      <span class="n">fontface</span> <span class="o">=</span> <span class="s">'bold'</span><span class="p">,</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="m">9</span><span class="o">/</span><span class="m">10</span><span class="p">,</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">background_legend</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">pyears</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>Consider this some kind of snippet to add the labels wherever you want, and in any size you want. Our function is basically doing some basic simple calculations to place the labelling inside the map area, on the bottom-left corner. The first part with the comment <code>## POSITION FOR THE LABELS</code> shows the basic calculations to do that, based on the coords, which should be the same as the coords specified in the map function. The calculations and the position are very stiff in size and location, but they will work the same regardless of the region mapped. On the other hand, it provides the basis for the function. Feel free to play with them to add custom options such as selecting the sizes or the corner where we want to display them.</p>
       <p>The rest of the code is intuitive, <code>geom_text</code> to add the info we want to show, one for the word "Year" and another one for the numeric value. We add the corresponding values to the <code>aes</code>, the sizes, some alpha for transparency and our colors defined in <code>map_colors</code>.</p>
       <pre><code class="highlight"><span></span><span class="n">my_print_totals</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_limits</span><span class="p">,</span> <span class="n">y_limits</span><span class="p">,</span> <span class="n">totals_label</span> <span class="o">=</span> <span class="s">"Totals"</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">## POSITION FOR THE LABELS</span>
  <span class="c1">## Starting points</span>
  <span class="n">x_units</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">x_limits[1]</span> <span class="o">-</span> <span class="n">x_limits[2]</span><span class="p">)</span><span class="o">/</span><span class="m">10</span>
  <span class="n">y_units</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">y_limits[1]</span> <span class="o">-</span> <span class="n">y_limits[2]</span><span class="p">)</span><span class="o">/</span><span class="m">10</span>
  <span class="n">start_x</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_units</span>
  <span class="n">start_y</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">y_limits</span><span class="p">)</span>
  <span class="c1">## Frame</span>
  <span class="n">rectangle.start.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span>
  <span class="n">rectangle.wide</span> <span class="o">&lt;-</span> <span class="n">rectangle.start.x</span> <span class="o">+</span> <span class="n">x_units</span>
  <span class="n">rectangle.start.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span>
  <span class="n">rectangle.high</span> <span class="o">&lt;-</span> <span class="n">rectangle.start.y</span> <span class="o">+</span> <span class="n">y_units</span>
  <span class="c1">## Text</span>
  <span class="n">num.size</span> <span class="o">&lt;-</span> <span class="m">4</span>
  <span class="n">text.size</span> <span class="o">&lt;-</span> <span class="m">3</span>  
  <span class="n">num.position.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_units</span><span class="o">*</span><span class="m">0.5</span><span class="p">)</span>
  <span class="n">text.position.x</span> <span class="o">&lt;-</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_units</span><span class="o">*</span><span class="m">0.5</span><span class="p">)</span>
  <span class="n">num.position.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_units</span><span class="o">*</span><span class="m">0.25</span><span class="p">)</span>
  <span class="n">text.position.y</span> <span class="o">&lt;-</span> <span class="n">start_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_units</span><span class="o">*</span><span class="m">0.65</span><span class="p">)</span>
  
    <span class="n">ptotals</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span>
        <span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">rectangle.start.x</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">rectangle.wide</span><span class="p">,</span>
                      <span class="n">ymin</span> <span class="o">=</span> <span class="n">rectangle.start.y</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">rectangle.high</span><span class="p">),</span>
                  <span class="n">color</span> <span class="o">=</span> <span class="s">'#283151'</span><span class="p">,</span>
                  <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">background_legend</span><span class="p">,</span>
                  <span class="n">alpha</span> <span class="o">=</span> <span class="m">9</span><span class="o">/</span><span class="m">10</span><span class="p">),</span>
        <span class="nf">geom_text</span><span class="p">(</span>
            <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">num.position.x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">num.position.y</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">totals</span><span class="p">),</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">num.size</span><span class="p">,</span>
            <span class="n">fontface</span> <span class="o">=</span> <span class="s">'bold'</span><span class="p">,</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="m">9</span><span class="o">/</span><span class="m">10</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">text_legend</span><span class="p">),</span>
        <span class="nf">geom_text</span><span class="p">(</span>
            <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">text.position.x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">text.position.y</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">totals_label</span><span class="p">),</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">text.size</span><span class="p">,</span>
            <span class="n">fontface</span> <span class="o">=</span> <span class="s">'bold'</span><span class="p">,</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="m">9</span><span class="o">/</span><span class="m">10</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">text_legend</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">ptotals</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>We can follow exactly the same approach for the totals, to place them right next to the year. For now we have to specify the value of the total that we want to be shown, but this actually should be calculated by the function. Actually, if you think about it, we are passing a great deal of information that should be coming from the previous functions, and we should keep here arguments that control the visuals of the labels only. That is not an easy topic and I decided to cover it in a separated post. Another reason why I don't want to show it yet is because I haven't decided yet which approach I want to use.</p>
       <p>So, for now we have to pass each argument to each function and make sure that we are passing the same argument, but that is easy to achieve in R by directing the values to an object before passing it to the functions. Let's see it in action.</p>
       <p>The dataset has already been stored in <code>datmx</code> and the colors in <code>map_colors</code>. Now we need to define a few more.</p>
       <pre><code class="highlight"><span></span><span class="n">x_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">)</span>
<span class="n">y_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">)</span>
<span class="n">yr</span> <span class="o">&lt;-</span> <span class="m">2020</span>
<span class="n">totals</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                <span class="n">x_coords</span><span class="p">,</span>
                <span class="n">y_coords</span><span class="p">,</span>
                <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">make_dots</span><span class="p">(</span><span class="nf">rbind</span><span class="p">(</span><span class="n">datmx</span><span class="p">,</span> <span class="n">datmx</span><span class="p">),</span>
            <span class="n">map_colors</span><span class="p">,</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">yr</span><span class="p">,</span>
            <span class="n">col_names</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">my_print_years</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s">"Año"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">my_print_totals</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s">"Totales"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-8-1.png"><img alt="plot of chunk unnamed-chunk-8" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-8-1.png"></a>
       </div>
       <p></p>
       <p>And there it is. Since my map is for Mexico, I am adding labels in Spanish. Feel free to test it in your own language and with more data. We can also have a look at how the labels fit to other countries, for example, smaller and bigger compared to Mexico.</p>
       <pre><code class="highlight"><span></span><span class="n">x_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">18</span><span class="p">)</span>
<span class="n">y_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">47</span><span class="p">,</span> <span class="m">56</span><span class="p">)</span>
<span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Germany"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                 <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span>
                 <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">my_print_years</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">my_print_totals</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">"A map of Germany"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-9-1.png"><img alt="plot of chunk unnamed-chunk-9" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-9-1.png"></a>
       </div>
       <p></p>
       <p>Germany is also looking good. And since we have the possibility of passing the values for year and totals, we don't actually need to have any data to test it, although the info shown is incorrect.</p>
       <pre><code class="highlight"><span></span><span class="n">x_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">28</span><span class="p">,</span> <span class="m">185</span><span class="p">)</span>
<span class="n">y_coords</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
<span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Russia"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                 <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span>
                 <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">my_print_years</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">my_print_totals</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-10-1.png"><img alt="plot of chunk unnamed-chunk-10" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-10-1.png"></a>
       </div>
       <p></p>
       <p>Russia is a very particular case because the country is quite long but not so wide. If we specify coordinates too narrow for latitude, the map does not look good and the labels start getting deformed. It would be the same case with Chile, if we make it narrow in longitude but it is naturally long in latitude. Since the main aim of the functions is to take care of the aesthetics and visualization, we have to ensure that this should not happen, somehow. Having certain degree of the labels is one way to do that. We will see a few more in the future.</p>
       <h1 class="article-header">Conclusions</h1>
       <p>If your aim is only to make maps like the above for any given country, our first 3 posts should have you covered. We could also import our functions to a shiny app and work with that. However, there are many improvements that we can still do.</p>
       <p>Now that we know the basis for functional programming with ggplot2, we can extend the power of our functions in the way how they share arguments by exploring the OOP (Object Oriented Programming) in R, the <code>ggproto</code> system to extend ggplot, and the use of environments.</p>
       <p>Since we want the maps to be dynamic in time, we could also work on a couple of functions to cover that. It could easily be achieved in a for loop, which is perfectly fine. We could also use the <code>apply</code> family of functions or the <code>map</code> family of functions from the <code>purrr</code> package (not to be confused with geographic maps or the package maps). The last options could be a bit of complication because of the excess of arguments in our functions. That only shows that it is worth it to still improve them.</p>
       <p>The next posts will be focused on this topic, so stay connected if you are interested on how I tackle these challenges.</p>
      </div>
     </article>
     <div class="article-comments">
      <script src="https://utteranc.es/client.js" repo="teotenn/blog.teoten.com" issue-term="pathname" theme="github-light" crossorigin="anonymous" async>
  </script>
     </div>
    </div>
    <button id="toggle-button">&lt;</button>
    <div id="sidebar" class="collapsed">
     <a href="https://blog.teoten.com/about/"> <img src="https://blog.teoten.com/img/tt-avatar.jpg" alt="Teoten" class="sidebar-image"> </a>
     <h2 class="h-sidebar">Links</h2>
     <ul>
      <li><a href="https://www.r-project.org/">The R Project</a></li>
      <li><a href="https://www.r-bloggers.com/">R-bloggers</a></li>
      <li><a href="https://clojure.org/">Clojure</a></li>
      <li><a href="https://www.gnu.org/software/emacs/">GNU Emacs</a></li>
     </ul>
     <h2 class="h-sidebar">Socials</h2>
     <ul class="horizontal-list">
      <li><a href="https://www.linkedin.com/in/teoten/"><i class="fab fa-linkedin-in"></i></a></li>
      <li><a href="https://codeberg.org/teoten"><i class="fab fa-github"></i></a></li>
      <li><a rel="me" href="https://social.linux.pizza/@teoten"><i class="fab fa-mastodon"></i></a></li>
     </ul>
    </div>
   </div>
  </div>
  <script src="/js/9c70eb7a56f7/scripts.js"></script>
 </body>
</html>