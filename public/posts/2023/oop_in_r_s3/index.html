<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
 <head>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather">
  <link href="/styles/1207b02cb143/styles.css" rel="stylesheet">
  <title>Object Oriented Programming in R: S3 | Teoten's blog</title>
  <meta name="description" content="Part of making maps of any region in the world with R using ggplot2 and maps packages: Object Oriented Programming">
  <link rel="canonical" href="https://blog.teoten.com/posts/2023/oop_in_r_s3/">
  <script type="application/ld+json">{"description":"Part of making maps of any region in the world with R using ggplot2 and maps packages: Object Oriented Programming","headline":"Object Oriented Programming in R: S3","@context":"https://schema.org","publisher":{"@type":"Person","name":"teoten"},"articleSection":"Programming","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.teoten.com/posts/2023/oop_in_r_s3/"},"datePublished":"2023-09-13T08:00:00+02:00","keywords":"R maps, OOP","author":{"@type":"Person","name":"Manuel Teodoro Tenango","url":"https://resume.teoten.com/","sameAs":["https://social.linux.pizza/@teoten","https://www.youtube.com/@teoten.programando"]},"dateModified":"2023-09-13T08:00:00+02:00","inLanguage":"en","image":"https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png","isPartOf":{"@type":"Blog","name":"Teoten's Blog","url":"https://blog.teoten.com"},"@type":"BlogPosting","about":[{"name":"R","@type":"Thing"}]}</script>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Teoten">
 </head>
 <body>
  <!-- Top nav bar -->
  <div>
   <!-- Toggle Button -->
   <button id="theme-toggle-btn" onclick="toggleTheme()"><i class="fas fa-sun"></i></button>
   <div id="wrapper">
    <nav id="navbar" class="navbar">
     <div class="navbar-container">
      <input type="checkbox" name="" id="">
      <div class="hamburger-lines">
       <span class="line line1"></span> <span class="line line2"></span> <span class="line line3"></span>
      </div>
      <ul class="menu-items">
       <li><a href="https://blog.teoten.com/">Home</a></li>
       <li><a href="https://blog.teoten.com/list/">Posts</a></li>
       <li><a href="https://blog.teoten.com/categories/">Categories</a></li>
       <li><a href="https://blog.teoten.com/tags/">Tags</a></li>
       <li><a href="https://blog.teoten.com/about/">About</a></li>
      </ul>
     </div>
    </nav>
   </div>
  </div>
  <div id="shadow-block">
   <div id="container">
    <div id="wide-content">
     <!-- Main content -->
     <div class="article-top">
      <img src="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png" class="article-top-image" alt="Object Oriented Programming in R: S3">
      <div class="article-title-container">
       <h1 class="article-title">Object Oriented Programming in R: S3</h1>
      </div>
      <div class="article-meta">
       <span> <i class="fa fa-calendar"> 2023-09-13</i> </span>
      </div>
     </div>
     <article id="post-/posts/2023/oop_in_r_s3/" data-post-id="/posts/2023/oop_in_r_s3/">
      <div>
       <p>This post is part of the series <a href="https://blog.teoten.com/series/maps-app/" title="maps-app">maps-app</a>.</p>
       <p>You can also find the current state of the project under <a href="https://github.com/teotenn">my GitHub</a> repo <a href="https://github.com/teotenn/mapic">mapic</a>.</p>
       <h1 class="article-header">Scope of this post</h1>
       <p>We are creating maps of data showing changes over a span of time for different countries and pointing at all kinds of cities. That basically means that we need to <strong>map any region of the world with R</strong>. Today there are all kinds of packages and techniques to do that. I will share the strategy I used with <a href="https://cran.r-project.org/web/packages/ggplot2/index.html">ggplot2</a> and <a href="https://cran.r-project.org/web/packages/maps/index.html">maps</a> packages, using support of <a href="https://www.openstreetmap.org/">Open Street Map</a> to obtain the coordinates of cities and finally making it interactive with <a href="https://shiny.rstudio.com/">shiny</a>.</p>
       <p>This series of posts share my path towards the creation of the Shiny app. It is a live project and I decided to share my path and experiences along the creation process. The posts are not only about the Shiny app, but the package I created behind it, including topics of functions crafting, creation of the maps, classes of objects, etc., as well as any interesting issue that appear on the way. It is my way to contribute to the R community and at the same time keeping the project documented for myself.</p>
       <p>This post is about <strong>Object Oriented Programming in R using S3 objects</strong>.</p>
       <p>I hope you all enjoy it. Feel free to leave any kind of comment and/or question at the end.</p>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png"><img alt="R Maps" src="https://blog.teoten.com/post/2022/map_any_region_with_ggplot2_part_I/maps_DrawingMap.png"></a>
       </div>
       <p></p>
       <h1 class="article-header">Object oriented programming and R</h1>
       <p>R is a programming language that benefits greatly from the paradigm of functional programming. This is actually how most of R users utilize it and how it is recommended. However, it also offers the possibility of applying object oriented programming (OOP) paradigm which is the creation and use of objects with defined characteristics and methods. If you have never heard of this concept I recommend you to do a little research about it before getting deep into this post. I would recommend to start with the introduction to OOP of <a href="https://adv-r.hadley.nz/oo.html">Advanced R</a>. It is not my intention to explain OOP but rather to use it, in combination with functional programming, to support sharing information between functions.</p>
       <p>If you followed the <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/">previous post</a> you might have noticed that at the <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#conclusions">conclusions</a> section I mentioned the use of OOP to extend our ggplot2 functions. The idea is to pass information between the functions to make the calculations more accurate rather than forcing the end user to repeat the information in each function. I mentioned the possibility of using environments, or the ggplot2 internal class <code>ggproto</code>. The use of environments has a different function than what I am trying to achieve here, while the <code>ggproto</code> objects are excellent to pass information between graphics created with <code>ggplot2</code> but they become complicated if we want to include any more information like data frames or lists of values. Therefore I decided to keep it simple with the use of S3 objects.</p>
       <p>S3 objects are the most commonly used in R packages, the recommended ones and apparently, the only ones used in base-r and stats packages. As <a href="https://adv-r.hadley.nz/s3.html">Hadley Wickham</a> says it:</p>
       <blockquote>
        <p>S3 is R’s first and simplest OO system. S3 is informal and ad hoc, but there is a certain elegance in its minimalism: you can’t take away any part of it and still have a useful OO system. For these reasons, you should use it, unless you have a compelling reason to do otherwise. S3 is the only OO system used in the base and stats packages, and it’s the most commonly used system in CRAN packages.</p>
        <p>S3 is very flexible, which means it allows you to do things that are quite ill-advised. If you’re coming from a strict environment like Java this will seem pretty frightening, but it gives R programmers a tremendous amount of freedom. It may be very difficult to prevent people from doing something you don’t want them to do, but your users will never be held back because there is something you haven’t implemented yet. Since S3 has few built-in constraints, the key to its successful use is applying the constraints yourself.</p>
       </blockquote>
       <h1 class="article-header">Implementation of S3 class objects for the creation of the maps</h1>
       <p>An S3 object in R is basically a structured list with a class name. It can be easily created by placing the list within the function <code>structure</code> and defining the <code>class</code>, <code>structure(list(...), class = c("class_name"))</code>, or by creating the list first and then setting the class of that list. Then we create generics using the function <code>UseMethod()</code> and add methods for each class by appending the class name to the generic, followed by a dot (i.e., <code>my_generic.MyClass</code>, <code>my_generic.vector</code>, <code>my_generic.matrix</code>, etc.).</p>
       <p>Let's start with a simple example.</p>
       <h2 class="article-header">A simple S3 object for the colors</h2>
       <p>We start by defining a function that initializes the object, our <strong>constructor</strong>. We should use this function to also check that our object contains the values that we need and throw some errors when there are mistakes.</p>
       <pre><code class="highlight"><span></span><span class="n">define_map_colors</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dots_orgs</span><span class="p">,</span>
                              <span class="n">target_country</span><span class="p">,</span>
                              <span class="n">empty_countries</span><span class="p">,</span>
                              <span class="n">border_countries</span><span class="p">,</span>
                              <span class="n">oceans</span><span class="p">,</span>
                              <span class="n">text_cities</span><span class="p">,</span>
                              <span class="n">text_legend</span><span class="p">,</span>
                              <span class="n">background_legend</span><span class="p">,</span>
                              <span class="n">text_copyright</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>

  <span class="c1">## Error handling</span>
  <span class="n">all_arguments</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">as.list</span><span class="p">(</span><span class="nf">environment</span><span class="p">()))</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">arggs</span> <span class="n">in</span> <span class="n">all_arguments</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">stopifnot</span><span class="p">(</span><span class="s">"All arguments must be character"</span> <span class="o">=</span> <span class="nf">is.character</span><span class="p">(</span><span class="n">arggs</span><span class="p">))</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">nchar</span><span class="p">(</span><span class="n">arggs</span><span class="p">)</span> <span class="o">!=</span> <span class="m">7</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">stop</span><span class="p">(</span><span class="s">"Colors should be in hex notation"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">arggs</span><span class="p">,</span> <span class="s">"^#"</span><span class="p">))</span> <span class="p">{</span>
      <span class="nf">stop</span><span class="p">(</span><span class="s">"Colors should be in hex notation"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">## S3 object definition</span>
  <span class="nf">structure</span><span class="p">(</span>
    <span class="nf">list</span><span class="p">(</span>
      <span class="n">dots_orgs</span> <span class="o">=</span> <span class="n">dots_orgs</span><span class="p">,</span>
      <span class="n">target_country</span> <span class="o">=</span> <span class="n">target_country</span><span class="p">,</span>
      <span class="n">empty_countries</span> <span class="o">=</span> <span class="n">empty_countries</span><span class="p">,</span>
      <span class="n">border_countries</span> <span class="o">=</span> <span class="n">border_countries</span><span class="p">,</span>
      <span class="n">oceans</span> <span class="o">=</span> <span class="n">oceans</span><span class="p">,</span>
      <span class="n">text_cities</span> <span class="o">=</span> <span class="n">text_cities</span><span class="p">,</span>
      <span class="n">text_legend</span> <span class="o">=</span> <span class="n">text_legend</span><span class="p">,</span>
      <span class="n">background_legend</span> <span class="o">=</span> <span class="n">background_legend</span><span class="p">,</span>
      <span class="n">text_copyright</span> <span class="o">=</span> <span class="n">text_copyright</span><span class="p">),</span>
    <span class="n">class</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"map_colors"</span><span class="p">))</span>
<span class="p">}</span>
</code></pre>
       <p>The function takes 9 arguments, each of them should be a color in hex notation, meaning that it must start with <code>#</code> and it must contain 6 alphanumeric characters (i.e., <code>#f0f0f0</code>). Thus, our error handling basically verifies that the parameters passed are of class <code>character</code> starting with <code>#</code> and containing exactly 7 symbols. Then, each of the 9 arguments is passed to a list within <code>structure</code> and set them to the class <code>map_colors</code>. And our object is created.</p>
       <pre><code class="highlight"><span></span><span class="n">default_map_colors</span> <span class="o">&lt;-</span> <span class="nf">define_map_colors</span><span class="p">(</span><span class="n">dots_orgs</span> <span class="o">=</span> <span class="s">"#493252"</span><span class="p">,</span>
                               <span class="n">target_country</span> <span class="o">=</span> <span class="s">"#8caeb4"</span><span class="p">,</span>
                               <span class="n">empty_countries</span> <span class="o">=</span> <span class="s">"#f3f3f3"</span><span class="p">,</span>
                               <span class="n">border_countries</span> <span class="o">=</span> <span class="s">"#9c9c9c"</span><span class="p">,</span>
                               <span class="n">oceans</span> <span class="o">=</span> <span class="s">"#4e91d2"</span><span class="p">,</span>
                               <span class="n">text_cities</span> <span class="o">=</span> <span class="s">"#a0a0a0"</span><span class="p">,</span>
                               <span class="n">text_legend</span> <span class="o">=</span> <span class="s">"#493252"</span><span class="p">,</span>
                               <span class="n">background_legend</span> <span class="o">=</span> <span class="s">"#ffffff"</span><span class="p">,</span>
                               <span class="n">text_copyright</span> <span class="o">=</span> <span class="s">"#f3f3f3"</span><span class="p">)</span>
</code></pre>
       <p>This is the same list of colors used in our <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/">previous post</a> by the <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#background-and-preliminaries">function that creates the maps</a>. If you check the class of our new list of colors, <code>class(default_map_colors)</code> it should be <code>map_colors</code>. Since our new object is also a list, we could use it indistinctly to create the maps. Thus, we need a method that verifies that our object is actually of the class <code>map_colors</code>. This is the <strong>validator</strong>. The method <code>is</code> already does that for other classes (i.e., <code>is.character()</code>) therefore, we can add our object to tell it how to handle it.</p>
       <pre><code class="highlight"><span></span><span class="n">is.map_colors</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">inherits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">"map_colors"</span><span class="p">)</span>

<span class="nf">is.map_colors</span><span class="p">(</span><span class="n">default_map_colors</span><span class="p">)</span>
</code></pre>
       <blockquote>
        <p>[1] TRUE</p>
       </blockquote>
       <p>The function is very simple, we just need to check if the object passed inherits the class. Now we can use <code>is.map_colors()</code> in all the functions that create maps in order to ensure that our new class is used rather than a simple list.</p>
       <h2 class="article-header">Creating a new object within a function</h2>
       <p>Once again, I have made improvements to the function presented before, <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#background-and-preliminaries">my<i>country</i>prev</a>. This time the change is only one, almost by the end of the body: the addition of an S3 object that holds information which is used later by other functions that add layers to the map. It is not only about the colors, but we are also adding the values of the limits, so that other functions, such as labels creation, know about it. Since this version is more stable, I have also renamed it to a more formal name.</p>
       <pre><code class="highlight"><span></span><span class="n">base_map</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span>
                     <span class="n">x_limits</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                     <span class="n">y_limits</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                     <span class="n">show_coords</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
                     <span class="n">return_mapic_obj</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                     <span class="n">map_colors</span> <span class="o">=</span> <span class="n">default_map_colors</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

  <span class="c1">## Verifying the arguments passed to the function</span>
  <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">country</span><span class="p">)</span> <span class="o">!=</span> <span class="m">1</span><span class="p">)</span> <span class="nf">stop</span><span class="p">(</span><span class="s">"Function supports only one country per map"</span><span class="p">)</span>
  <span class="nf">stopifnot</span><span class="p">(</span><span class="nf">is.logical</span><span class="p">(</span><span class="n">show_coords</span><span class="p">))</span>
  <span class="nf">stopifnot</span><span class="p">(</span><span class="s">"Name of the country should be character"</span> <span class="o">=</span> <span class="nf">is.character</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>

  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">country</span> <span class="o">%in%</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span><span class="o">$</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">stop</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">"Country name not recognized"</span><span class="p">,</span>
               <span class="s">"To see a list of recognized countries run"</span><span class="p">,</span>
               <span class="s">"&lt;unique(maps::map_data('world')$region)&gt;"</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">"\n"</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="c1">## If coords limits missing, print worldwide map with coordinates system to allow</span>
  <span class="c1">## User observe coords for reference</span>
  <span class="nf">if </span><span class="p">(</span><span class="nf">missing</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span> <span class="o">||</span> <span class="nf">missing</span><span class="p">(</span><span class="n">y_limits</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">warning</span><span class="p">(</span><span class="s">"X and/or Y limits not provided.\nPrinting worldwide map."</span><span class="p">)</span>
    <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">))</span>
  <span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">show_coords</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">))</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span> <span class="o">!=</span> <span class="m">2</span> <span class="o">||</span> <span class="nf">length</span><span class="p">(</span><span class="n">y_limits</span><span class="p">)</span> <span class="o">!=</span> <span class="m">2</span> <span class="o">||</span>
         <span class="o">!</span><span class="nf">all</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">"^-?[0-9.]+$"</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="n">x_limits</span><span class="p">,</span> <span class="n">y_limits</span><span class="p">))))</span> <span class="p">{</span>
      <span class="nf">stop</span><span class="p">(</span><span class="s">"Limits for X and Y coords should be provided as vectors with two numeric values"</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>

      <span class="c1">## Custom theme for the final map</span>
      <span class="n">map_country_theme</span> <span class="o">&lt;-</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
        <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">oceans</span><span class="p">),</span>
              <span class="n">legend.position</span> <span class="o">=</span> <span class="s">"none"</span><span class="p">,</span>
              <span class="n">panel.grid.major</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.line</span> <span class="o">=</span> <span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="s">"black"</span><span class="p">),</span>
              <span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.text.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.ticks.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.text.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
              <span class="n">axis.ticks.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">## Get the target cpuntry data</span>
  <span class="n">map_data_country</span> <span class="o">&lt;-</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span><span class="nf">[map_data</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span><span class="o">$</span><span class="n">region</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="n">]</span>

  <span class="c1">## The map</span>
  <span class="n">mapic</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>
    <span class="c1">## First layer: worldwide map</span>
    <span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nf">map_data</span><span class="p">(</span><span class="s">"world"</span><span class="p">),</span>
                 <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">),</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">border_countries</span><span class="p">,</span>
                 <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">empty_countries</span><span class="p">)</span> <span class="o">+</span>
    <span class="c1">## Second layer: Country map</span>
    <span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">map_data_country</span><span class="p">,</span>
                 <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">),</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">border_countries</span><span class="p">,</span>
                 <span class="n">fill</span> <span class="o">=</span> <span class="n">map_colors</span><span class="o">$</span><span class="n">target_country</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">coord_map</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">coord_fixed</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">x_limits</span><span class="p">,</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">y_limits</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">map_country_theme</span>

  <span class="nf">if </span><span class="p">(</span><span class="n">return_mapic_obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">map_pointer</span> <span class="o">&lt;-</span> <span class="nf">structure</span><span class="p">(</span>
      <span class="nf">list</span><span class="p">(</span>
        <span class="n">mapic</span> <span class="o">=</span> <span class="n">mapic</span><span class="p">,</span>
        <span class="n">base_map</span> <span class="o">=</span> <span class="n">mapic</span><span class="p">,</span>
        <span class="n">x_limits</span> <span class="o">=</span> <span class="n">x_limits</span><span class="p">,</span>
        <span class="n">y_limits</span> <span class="o">=</span> <span class="n">y_limits</span><span class="p">,</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">map_colors</span>
      <span class="p">),</span>
      <span class="n">class</span> <span class="o">=</span> <span class="s">"mapicHolder"</span><span class="p">)</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">map_pointer</span><span class="p">)</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">mapic</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
       <p>The new <code>base_map</code> does the same as the previous <code>my_country_prev</code>: it creates the base map of a country. However, we have added the option to return a mapic object or not. When the option, <code>return_mapic_obj</code> is set to <code>FALSE</code>, the function behaves as before and it returns the map only. But when it is set as <code>TRUE</code>, it generates a new object of class <code>mapicHolder</code> that holds the information that will be piped to other functions as we mentioned above. Other changes are minimal regarding style, the function still does the same.</p>
       <p>As you can see, the object does not necessarily has to be available to the end user for manipulation or modification. Here we can create 2 different objects to move forward with the creation of the maps and the end user does not need to know the structure or even the existence of the object. Thus, <code>spain &lt;- base_map("Spain")</code> will create an object with the base map for Spain, and <code>france &lt;- base_map("France")</code> creates a similar object for the base map of France. Each of them in an object of class <code>mapicHolder</code> that can be called later. The idea is to be able to use the information of each of them easily by the rest of the functions that add layers to our maps.</p>
       <h2 class="article-header">Defining our own methods</h2>
       <p>Now that we have our S3 object and we know how to modify methods, let's create a new method specially for it. We are going to replace our previous function <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#a-map-with-growing-dots-per-city">make_dots</a> for a method that works differently depending on the class of object that is passed. The initialization is pretty simple, it can be accomplished in one line:</p>
       <pre><code class="highlight"><span></span><span class="n">make_dots</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="nf">UseMethod</span><span class="p">(</span><span class="s">"make_dots"</span><span class="p">)</span>
</code></pre>
       <p>After this <code>make_dots</code> exists as a method which behavior we can modified based on the class of the object passed. Notice the ellipsis (the three dots <code>...</code>) in the function definition, they are necessary to ensure that all the arguments defined after our object (<code>x</code>) are taken into account as well.</p>
       <p>With this we can re-write the definition of our function <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#a-map-with-growing-dots-per-city">make_dots</a>, or in other words, its name, to have it as the default behavior. The body of the function remains the same.</p>
       <pre><code class="highlight"><span></span><span class="n">make_dots.default</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">.df</span><span class="p">,</span>
                      <span class="n">year</span><span class="p">,</span>
                      <span class="n">map_colors</span><span class="p">,</span>
                      <span class="n">column_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="s">"lat"</span><span class="p">,</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="s">"lon"</span><span class="p">,</span>
                        <span class="n">cities</span> <span class="o">=</span> <span class="s">"city"</span><span class="p">,</span>
                        <span class="n">start_year</span> <span class="o">=</span> <span class="s">"year"</span><span class="p">,</span>
                        <span class="n">end_year</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">),</span>
                      <span class="n">dot_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kc">...</span>
<span class="p">}</span>
</code></pre>
       <p>The function should be working as if no changes were done. The advantage is that now, we can create a second one, with the same name, which will behave differently when our object <code>mapicHolder</code> is used.</p>
       <pre><code class="highlight"><span></span><span class="n">make_dots.mapicHolder</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">.mapic_holder</span><span class="p">,</span>
                                        <span class="n">.df</span><span class="p">,</span>
                                        <span class="n">year</span><span class="p">,</span>
                                        <span class="n">column_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
                                          <span class="n">lat</span> <span class="o">=</span> <span class="s">"lat"</span><span class="p">,</span>
                                          <span class="n">lon</span> <span class="o">=</span> <span class="s">"lon"</span><span class="p">,</span>
                                          <span class="n">cities</span> <span class="o">=</span> <span class="s">"city"</span><span class="p">,</span>
                                          <span class="n">start_year</span> <span class="o">=</span> <span class="s">"year"</span><span class="p">,</span>
                                          <span class="n">end_year</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">),</span>
                                        <span class="n">dot_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
  <span class="nf">require</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>

  <span class="n">column_names</span> <span class="o">&lt;-</span> <span class="n">column_names</span><span class="nf">[lengths</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span><span class="n">]</span>
  <span class="n">year__</span> <span class="o">&lt;-</span> <span class="n">year</span>

  <span class="c1">## Check required fields</span>
  <span class="n">mandatory_cols</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"lat"</span><span class="p">,</span> <span class="s">"lon"</span><span class="p">,</span> <span class="s">"cities"</span><span class="p">,</span> <span class="s">"start_year"</span><span class="p">)</span>
  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">all</span><span class="p">(</span><span class="n">mandatory_cols</span> <span class="o">%in%</span> <span class="nf">names</span><span class="p">(</span><span class="n">column_names</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nf">stop</span><span class="p">(</span><span class="s">"Column names missing!"</span><span class="p">)</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="s">"end_year"</span> <span class="o">%in%</span> <span class="nf">names</span><span class="p">(</span><span class="n">column_names</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">.df</span><span class="o">$</span><span class="n">final_year</span> <span class="o">&lt;-</span> <span class="kc">NA_real_</span>
      <span class="n">column_names[[</span><span class="s">"end_year"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="s">"final_year"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">## Make map using default method</span>
  <span class="n">mapic_dots</span> <span class="o">&lt;-</span> <span class="nf">make_dots</span><span class="p">(</span><span class="n">.df</span> <span class="o">=</span> <span class="n">.df</span><span class="p">,</span>
                          <span class="n">year</span> <span class="o">=</span> <span class="n">year__</span><span class="p">,</span>
                          <span class="n">map_colors</span> <span class="o">=</span> <span class="n">.mapic_holder</span><span class="o">$</span><span class="n">colors</span><span class="p">,</span>
                          <span class="n">column_names</span> <span class="o">=</span> <span class="n">column_names</span><span class="p">,</span>
                          <span class="n">dot_size</span> <span class="o">=</span> <span class="n">dot_size</span><span class="p">)</span>

  <span class="c1">## Papere the data</span>
  <span class="n">data_for_map</span> <span class="o">&lt;-</span> <span class="n">.df</span>  <span class="o">%&gt;%</span>
    <span class="nf">mutate_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">end_year</span><span class="p">),</span> <span class="o">~</span><span class="nf">replace_na</span><span class="p">(</span><span class="n">.,</span> <span class="n">year__</span> <span class="o">+</span> <span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">mutate</span><span class="p">(</span><span class="n">year_final</span> <span class="o">=</span> <span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">end_year</span><span class="p">),</span>
           <span class="n">city_name</span> <span class="o">=</span> <span class="nf">str_to_sentence</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">cities</span><span class="p">)))</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span><span class="n">year_final</span> <span class="o">&gt;</span> <span class="n">year__</span> <span class="o">&amp;</span> <span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">start_year</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">year__</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">group_by</span><span class="p">(</span><span class="n">city_name</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">summarise</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nf">median</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">lon</span><span class="p">),</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
              <span class="n">y</span> <span class="o">=</span> <span class="nf">median</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">column_names</span><span class="o">$</span><span class="n">lat</span><span class="p">),</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
              <span class="n">n</span> <span class="o">=</span> <span class="nf">n</span><span class="p">())</span>

  <span class="c1">## Empty theme for labels</span>
  <span class="n">empty_theme</span> <span class="o">&lt;-</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">"none"</span><span class="p">,</span>
          <span class="n">panel.grid.major</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.line</span> <span class="o">=</span> <span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="s">"white"</span><span class="p">),</span>
          <span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.text.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.ticks.x</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.text.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">axis.ticks.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">plot.margin</span> <span class="o">=</span> <span class="nf">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-0</span><span class="p">,</span> <span class="m">-0</span><span class="p">,</span> <span class="m">-0</span><span class="p">,</span> <span class="m">-0</span><span class="p">),</span> <span class="s">"cm"</span><span class="p">))</span>

  <span class="n">.mapic_holder[[</span><span class="s">"theme_labels"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">empty_theme</span>
  <span class="n">.mapic_holder[[</span><span class="s">"mapic_dots"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">mapic_dots</span>
  <span class="n">.mapic_holder[[</span><span class="s">"year"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">year__</span>
  <span class="n">.mapic_holder[[</span><span class="s">"data"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="n">.df</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">data_for_map</span><span class="p">)</span>
  <span class="n">.mapic_holder[[</span><span class="s">"mapic"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">.mapic_holder[[</span><span class="s">"mapic"</span><span class="n">]]</span> <span class="o">+</span> <span class="n">mapic_dots</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">.mapic_holder</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>The new function is basically applying the default function to the data, but the parameters required are different: we now request the object of class <code>mapicHolder</code> but we don't need to request the <code>map_colors</code> because they come within the mentioned object. Additionally, we are adding additional data to our <code>mapicHolder</code> to be passed and used for more functions.</p>
       <p>Now we have two options to create the maps. One specifying every parameter like in the <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2">previous post</a> using the <code>.default</code> method:</p>
       <pre><code class="highlight"><span></span><span class="nf">base_map</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                 <span class="n">x_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">),</span>
                 <span class="n">y_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">),</span>
                 <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">make_dots</span><span class="p">(</span><span class="n">datmx</span><span class="p">,</span>
            <span class="n">year</span> <span class="o">=</span> <span class="m">2022</span><span class="p">,</span>
            <span class="n">map_colors</span><span class="p">,</span> <span class="n">column_names</span> <span class="o">=</span> <span class="n">col_names</span><span class="p">)</span>
</code></pre>
       <p>Or the new version where the <code>mapicHolder</code> can be piped from function to function:</p>
       <pre><code class="highlight"><span></span><span class="nf">base_map</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
         <span class="n">map_colors</span><span class="p">,</span>
         <span class="n">x_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-118</span><span class="p">,</span> <span class="m">-86</span><span class="p">),</span>
         <span class="n">y_limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">14</span><span class="p">,</span> <span class="m">34</span><span class="p">),</span>
         <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">|&gt;</span>
  <span class="nf">make_dots</span><span class="p">(</span><span class="n">datmx</span><span class="p">,</span>
            <span class="n">year</span> <span class="o">=</span> <span class="m">2022</span><span class="p">,</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">col_names</span><span class="p">)</span>
</code></pre>
       <p>It has been a good exercise to learn the basis of S3 object but so far the differences between one and the other are minimal. Other than avoid repeating the list of colors, there is not much gain. However, all the information that we have gathered in our <code>mapicHolder</code> object has high value to create the labels accurately and to place them in a proper position.</p>
       <h2 class="article-header">Passing information to the labels</h2>
       <p>To have our map complete, we are going to pass our <code>mapicHolder</code> to the functions that print the years and the totals. As we did above, we first create our method and define its default behaviour.</p>
       <pre><code class="highlight"><span></span><span class="n">my_print_totals</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="nf">UseMethod</span><span class="p">(</span><span class="s">"my_print_totals"</span><span class="p">)</span>

<span class="n">my_print_totals.default</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">totals</span><span class="p">,</span> <span class="n">map_colors</span><span class="p">,</span> <span class="n">x_limits</span><span class="p">,</span> <span class="n">y_limits</span><span class="p">,</span> <span class="n">totals_label</span> <span class="o">=</span> <span class="s">"Totals"</span><span class="p">)</span> <span class="p">{</span>
  <span class="kc">...</span>
<span class="p">}</span>
</code></pre>
       <p>You can find the <a href="https://blog.teoten.com/posts/2023/programming_with_ggplot2/#adding-labels-for-the-map">code of the original functions</a> in my previous post. Now for our new function we can basically remove all the parameters and add only a <code>mapicHolder</code> object, which already contains the rest of the information.</p>
       <pre><code class="highlight"><span></span><span class="n">my_print_totals.mapicHolder</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">.mapic_holder</span><span class="p">,</span>
                                        <span class="n">totals_label</span> <span class="o">=</span> <span class="s">"Totals"</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">data_totals</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">.mapic_holder</span><span class="o">$</span><span class="n">data</span><span class="o">$</span><span class="n">map</span><span class="o">$</span><span class="n">n</span><span class="p">)</span>
  <span class="n">mapic_totals</span> <span class="o">&lt;-</span> <span class="nf">my_print_totals</span><span class="p">(</span><span class="n">totals</span> <span class="o">=</span> <span class="n">data_totals</span><span class="p">,</span>
                                  <span class="n">x_limits</span> <span class="o">=</span> <span class="n">.mapic_holder</span><span class="o">$</span><span class="n">x_limits</span><span class="p">,</span>
                                  <span class="n">y_limits</span> <span class="o">=</span> <span class="n">.mapic_holder</span><span class="o">$</span><span class="n">y_limits</span><span class="p">,</span>
                                  <span class="n">totals_label</span> <span class="o">=</span> <span class="n">totals_label</span><span class="p">,</span>
                                  <span class="n">map_colors</span> <span class="o">=</span> <span class="n">.mapic_holder</span><span class="o">$</span><span class="n">colors</span><span class="p">)</span>

  <span class="n">.mapic_holder[[</span><span class="s">"mapic_totals"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">mapic_totals</span>
  <span class="n">.mapic_holder[[</span><span class="s">"totals"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">data_totals</span>
  <span class="n">.mapic_holder[[</span><span class="s">"mapic"</span><span class="n">]]</span> <span class="o">&lt;-</span> <span class="n">.mapic_holder[[</span><span class="s">"mapic"</span><span class="n">]]</span> <span class="o">+</span> <span class="n">mapic_totals</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">.mapic_holder</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
       <p>Basically the body of <code>my_print_totals.mapicHolder</code> consists of passing the right parameters to <code>my_print_totals.default</code>, and adding the new layer to the <code>mapicHolder</code>. We can do exactly the same for the years and we will have the complete map ready to be shown.</p>
       <h1 class="article-header">Creating the map</h1>
       <p>Before we are able to pipe and show the map, we need a couple preparations more. In order to show the map when we call our object, rather than a bunch of information, we need to add our object class to <code>print</code>.</p>
       <pre><code class="highlight"><span></span><span class="n">print.mapicHolder</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">mapic</span><span class="p">)</span>
</code></pre>
       <p>It will be useful to do the same for <code>plot</code>.</p>
       <pre><code class="highlight"><span></span><span class="n">plot.mapicHolder</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">mapic</span><span class="p">)</span>
</code></pre>
       <p>Now we can simply pipe one function after the other and reduce the amount of arguments passed to each function.</p>
       <pre><code class="highlight"><span></span><span class="nf">my_country_prev</span><span class="p">(</span><span class="s">"Mexico"</span><span class="p">,</span>
                <span class="n">map_colors</span><span class="p">,</span>
                <span class="n">x_coords</span><span class="p">,</span>
                <span class="n">y_coords</span><span class="p">,</span>
                <span class="n">show_coords</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">|&gt;</span>
  <span class="nf">make_dots</span><span class="p">(</span><span class="nf">rbind</span><span class="p">(</span><span class="n">datmx</span><span class="p">,</span> <span class="n">datmx</span><span class="p">),</span>
            <span class="n">year</span> <span class="o">=</span> <span class="m">2020</span><span class="p">,</span>
            <span class="n">col_names</span><span class="p">)</span> <span class="o">|&gt;</span>
  <span class="nf">my_print_years</span><span class="p">(</span><span class="n">year_label</span> <span class="o">=</span> <span class="s">"Año"</span><span class="p">)</span> <span class="o">|&gt;</span>
  <span class="nf">my_print_totals</span><span class="p">(</span><span class="n">totals_label</span> <span class="o">=</span> <span class="s">"Totales"</span><span class="p">)</span>
</code></pre>
       <p></p>
       <div class="article-image-container">
        <a href="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-8-1.png"><img alt="plot of chunk unnamed-chunk-8" src="https://blog.teoten.com/post/2023/map_any_region_with_ggplot2_part_III/unnamed-chunk-8-1.png"></a>
       </div>
       <p></p>
       <h1 class="article-header">Final Remarks</h1>
       <p>Now we have not only a functional workflow for the creation of the maps, but also a more user friendly one. If it is true that it does not follow the standards of <code>ggplot2</code> of adding layers using <code>+</code>, it uses the R pipe introduced in version 4.0 (we can also use dplyr's pipe <code>%&gt;%</code>) which makes more sense, since it is the direction that R as a whole is taking.</p>
       <p>In the next post we will step back to the coordinates manipulation to implement a new system of objects to be able to use different types of databases. For now, our functions are able to use only <code>SQLite</code> and <code>data.frame</code> to store the information, which is fine for prototyping or for small projects, but very limited for production usage.</p>
      </div>
     </article>
     <div class="article-comments">
      <script src="https://utteranc.es/client.js" repo="teotenn/blog.teoten.com" issue-term="pathname" theme="github-light" crossorigin="anonymous" async>
  </script>
     </div>
    </div>
    <button id="toggle-button">&lt;</button>
    <div id="sidebar" class="collapsed">
     <a href="https://blog.teoten.com/about/"> <img src="https://blog.teoten.com/img/tt-avatar.jpg" alt="Teoten" class="sidebar-image"> </a>
     <h2 class="h-sidebar">Links</h2>
     <ul>
      <li><a href="https://www.r-project.org/">The R Project</a></li>
      <li><a href="https://www.r-bloggers.com/">R-bloggers</a></li>
      <li><a href="https://clojure.org/">Clojure</a></li>
      <li><a href="https://www.gnu.org/software/emacs/">GNU Emacs</a></li>
     </ul>
     <h2 class="h-sidebar">Socials</h2>
     <ul class="horizontal-list">
      <li><a href="https://www.linkedin.com/in/teoten/"><i class="fab fa-linkedin-in"></i></a></li>
      <li><a href="https://codeberg.org/teoten"><i class="fab fa-github"></i></a></li>
      <li><a rel="me" href="https://social.linux.pizza/@teoten"><i class="fab fa-mastodon"></i></a></li>
     </ul>
    </div>
   </div>
  </div>
  <script src="/js/9c70eb7a56f7/scripts.js"></script>
 </body>
</html>